import requests

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL = "qwen2.5:7b-instruct"

LEGAL_KNOWLEDGE = """
คุณคือผู้เชี่ยวชาญด้านการตรวจสอบโฆษณาในประเทศไทย
อ้างอิงแนวทาง:
- อย. ประเทศไทย
- หลักการโฆษณาไม่เกินจริง
- ห้ามใช้คำอ้างผลลัพธ์แน่นอน เช่น หายขาด, 100%, การันตีผล
- ห้ามอ้างสรรพคุณทางการแพทย์โดยไม่มีหลักฐาน
"""

def _call_llm(prompt: str) -> str:
    res = requests.post(
        OLLAMA_URL,
        json={
            "model": MODEL,
            "prompt": prompt,
            "stream": False
        },
        timeout=60
    )
    res.raise_for_status()
    return res.json()["response"].strip()

def explain_with_llm(text: str, found_words: list[str]) -> str:
    prompt = f"""
[บทบาทของคุณ]
คุณคือ "ผู้ตรวจสอบโฆษณา" ไม่ใช่แพทย์ ไม่ใช่นักโภชนาการ

[ขอบเขตที่ห้ามออกนอกเรื่อง]
- ห้ามให้คำแนะนำด้านสุขภาพ
- ห้ามอธิบายสรรพคุณสินค้า
- วิเคราะห์เฉพาะเชิงกฎหมายเท่านั้น

[เกณฑ์อ้างอิง]
- แนวทางโฆษณา อย. ประเทศไทย
- หลักโฆษณาไม่เกินจริง
- คำต้องห้าม เช่น หายขาด, 100%, เห็นผลทันที, การันตีผล

[ข้อความโฆษณา]
{text}

[คำที่ระบบตรวจพบ]
{', '.join(found_words)}

[รูปแบบคำตอบที่ต้องใช้เท่านั้น]
- สรุปผล: (เข้าข่าย / ไม่เข้าข่าย)
- เหตุผล:
  1) ...
  2) ...
- อ้างอิงแนวทาง อย.:

ห้ามเขียนย่อหน้าอื่นนอกเหนือจากนี้
ตอบเป็นภาษาไทย กระชับ เป็นข้อ
"""
    return _call_llm(prompt)


def suggest_safe_text(original_text: str) -> str:
    prompt = f"""
คุณคือ "นักกฎหมายโฆษณาไทย"

หน้าที่เดียวของคุณ:
- แก้ไขข้อความให้ไม่ผิดกฎหมายโฆษณา
- ห้ามเพิ่มสรรพคุณใหม่
- ห้ามการันตีผล
- ห้ามใช้คำเชิงรักษา

ข้อความต้นฉบับ:
{original_text}

กติกาการเขียน:
- ใช้ภาษากลาง
- ใช้คำว่า "อาจ", "มีส่วนช่วย", "ขึ้นอยู่กับแต่ละบุคคล"
- ไม่เกิน 3–4 ประโยค

รูปแบบคำตอบ:
[ข้อความโฆษณาที่ปรับแล้ว]
(เขียนเฉพาะข้อความใหม่ ไม่ต้องอธิบาย)
"""
    return _call_llm(prompt)
def rewrite_sentence_safe(sentence: str) -> str:
    prompt = f"""
คุณคือผู้เชี่ยวชาญกฎหมายโฆษณาไทย

หน้าที่:
- ปรับ "เพียง 1 ประโยค" ให้ไม่เข้าข่ายโฆษณาเกินจริง
- ห้ามใช้คำการันตีผล
- ห้ามเพิ่มสรรพคุณใหม่
- ต้องยังคงความหมายเชิงการตลาดเดิม

ประโยคต้นฉบับ:
"{sentence}"

กติกา:
- ใช้ภาษาคนทั่วไป
- ความยาวใกล้เคียงต้นฉบับ
- ตอบกลับมาเป็น "ประโยคเดียวเท่านั้น"

ประโยคที่ปลอดภัย:
"""
    return _call_llm(prompt)
